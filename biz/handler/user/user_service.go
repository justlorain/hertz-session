// Code generated by hertz generator.

package user

import (
	"context"
	"github.com/cloudwego/hertz/pkg/app"
	hutils "github.com/cloudwego/hertz/pkg/common/utils"
	"github.com/hertz-contrib/sessions"
	"hertz-session/biz/dal/mysql"
	"hertz-session/biz/model/user"
	"hertz-session/pkg/consts"
	"hertz-session/pkg/utils"
	"net/http"
)

// Register .
// @router /register [POST]
func Register(_ context.Context, c *app.RequestContext) {
	var err error
	var req user.RegisterRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.HTML(http.StatusOK, "register.html", hutils.H{
			"message": utils.BuildMsg(err.Error()),
		})
		return
	}
	users, err := mysql.FindUserByNameOrEmail(req.Username, req.Email)
	if err != nil {
		c.HTML(http.StatusOK, "register.html", hutils.H{
			"message": utils.BuildMsg(err.Error()),
		})
		return
	}
	if len(users) != 0 {
		c.HTML(http.StatusOK, "register.html", hutils.H{
			"message": utils.BuildMsg(consts.RegisterErr),
		})
		return
	}
	if err = mysql.CreateUsers([]*mysql.User{
		{
			Username: req.Username,
			Password: utils.MD5(req.Password),
			Email:    req.Email,
		},
	}); err != nil {
		c.HTML(http.StatusOK, "register.html", hutils.H{
			"message": utils.BuildMsg(consts.RegisterErr),
		})
		return
	}
	c.HTML(http.StatusOK, "register.html", hutils.H{
		"message": consts.Success,
	})
}

// Login .
// @router /login [POST]
func Login(_ context.Context, c *app.RequestContext) {
	var err error
	var req user.LoginRequest
	err = c.BindAndValidate(&req)
	if err != nil {
		c.HTML(http.StatusOK, "login.html", hutils.H{
			"message": utils.BuildMsg(err.Error()),
		})
		return
	}
	users, err := mysql.CheckUser(req.Username, utils.MD5(req.Password))
	if err != nil {
		c.HTML(http.StatusOK, "login.html", hutils.H{
			"message": utils.BuildMsg(err.Error()),
		})
		return
	}
	if len(users) == 0 {
		c.HTML(http.StatusOK, "login.html", hutils.H{
			"message": utils.BuildMsg(consts.LoginErr),
		})
		return
	}
	session := sessions.Default(c)
	session.Set(consts.Username, req.Username)
	_ = session.Save()
	c.Redirect(http.StatusMovedPermanently, []byte("/page"))
}

func Page(_ context.Context, c *app.RequestContext) {
	session := sessions.Default(c)
	username := session.Get(consts.Username)
	if username == nil {
		c.HTML(http.StatusOK, "page.html", hutils.H{
			"message": utils.BuildMsg(consts.PageErr),
		})
		c.Redirect(http.StatusMovedPermanently, []byte("/login"))
		return
	}
	c.HTML(http.StatusOK, "page.html", hutils.H{
		"message": utils.BuildMsg(username.(string)),
	})
	return
}

func Logout(_ context.Context, c *app.RequestContext) {
	c.Redirect(http.StatusMovedPermanently, []byte("/login"))
}
